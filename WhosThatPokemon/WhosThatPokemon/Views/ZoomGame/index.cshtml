@{
    ViewData["Title"] = "Zoom Pokémon";
}

<partial name="_LogoutBall" />

<style>

.title-container {
    position: relative;
    text-align: center;
    padding-top: 10px;
    width: 100%;
    height: 25vh;
}

.pokemon-title {
    font-weight: normal;
    margin: 0;
    position: absolute;
    width: 100%;

    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%);

    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 0.9;
}

.pokemon-title.hollow {
    font-family: 'Pokemon Hollow', sans-serif;
    color: #2a75bb;
    -webkit-text-stroke: 15px #003a70;

    text-shadow:
        3px 0 0 #003a70,
        -3px 0 0 #003a70,
        0 3px 0 #003a70,
        0 -3px 0 #003a70,
        2px 2px 0 #003a70,
        -2px -2px 0 #003a70,
        2px -2px 0 #003a70,
        -2px 2px 0 #003a70;

    font-size: 7vw;
}

.pokemon-title.solid {
    font-family: 'Pokemon Solid', sans-serif;
    color: #FFCB05;
    font-size: 7vw;
}

.back-button {
    position: fixed;
    top: 12px;
    left: 12px;
    z-index: 1400;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 44px;
    border-radius: 10px;
    background: linear-gradient(180deg,#1d5fe0,#124aa8);
    color: #fff;
    text-decoration: none;
    font-size: 26px;
    font-weight: 800;
    border: 3px solid rgba(10,40,120,0.9);
    box-shadow: 0 6px 14px rgba(10,40,120,0.28);
    transition: transform .12s ease, box-shadow .12s ease;
}
.back-button:hover, .back-button:focus {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 18px rgba(10,40,120,0.36);
}

.zoom-container {
    width: 320px;
    height: 320px;
    margin: 20px auto;
    border-radius: 20px;
    overflow: hidden;
    background: white;
    box-shadow: 0 0 20px rgba(0,0,0,0.25);
    padding-top: 20px;
}
.zoom-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform-origin: center;
    transition: transform 0.3s ease-out;
    user-drag: none;
    user-select: none;
    -webkit-user-drag: none;
    pointer-events: none;
    touch-action: none;
}
.message {
    text-align:center;
    margin-top:15px;
    font-size:20px;
    font-weight:bold;
    color:#c0392b;
    padding-top: 10px;
}
.attempts {
    text-align:center;
    font-size:18px;
    margin-top:10px;
    font-family: 'Press Start 2P', cursive;
    letter-spacing: 1px;
}

.guess-box {
    text-align:center;
    margin-top:20px;
}
.guess-box input {
    padding:10px;
    width:40%;
    border-radius:10px;
    border:1px solid #aaa;
}
.guess-box button {
    margin-top:10px;
    padding:10px 20px;
    background:#27ae60;
    border:none;
    color:white;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
}

.ui-autocomplete {
    max-height: 260px;
    overflow-y: auto;
    overflow-x: hidden;
    z-index: 2000 !important;
    background: white;
}
.ui-menu-item-wrapper { display:flex; align-items:center; gap:8px; padding:6px 8px; }
.ui-menu-item-wrapper img { width:36px; height:36px; object-fit:contain; image-rendering:pixelated; }

</style>

<div class="title-container">
    <h1 class="pokemon-title hollow">
        <span>Who's That</span>
        <span>Pokémon?</span>
    </h1>
    <h1 class="pokemon-title solid">
        <span>Who's That</span>
        <span>Pokémon?</span>
    </h1>
</div>
@{
    ViewData["BodyClass"] = "classic-game-page";
}

<a asp-controller="Games" asp-action="Index" class="back-button" title="Volver a Games" aria-label="Volver a Games">
    &#8592;
</a>

@if (ViewBag.Message != null)
{
    <div class="message">@ViewBag.Message</div>
}

<div class="zoom-container">
    @if (ViewBag.Sprite != null)
    {
        <img class="zoom-img"
             draggable="false"
             ondragstart="return false;"
             onmousedown="return false;"
             src="@ViewBag.Sprite"
             style="transform: scale(@(1 + (ViewBag.ZoomLevel * 0.8)))" />
    }
</div>

<div class="attempts">
    Intentos: @ViewBag.Attempts / 6
</div>

<div class="guess-box">
    <form asp-action="Guess" asp-controller="ZoomGame" method="post" id="guessForm">
        <input id="guessBox" name="guess" placeholder="Adivina el Pokémon..." autocomplete="off" required />
        <br />
        <button type="submit">Adivinar</button>
    </form>

    <br />

    <form asp-action="Index" asp-controller="ZoomGame" method="get">
        <button style="background:#2980b9;">Nuevo Pokémon</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />

<!-- Autocomplete-->
<script>
    (function($){
        $(function() {
            const url = '@Url.Action("SearchPokemon", "ZoomGame")';

            function normalizeItem(item){
                return {
                    label: item.name || item.Name || item.label || "",
                    value: item.name || item.Name || item.value || "",
                    image: item.imageUrl || item.ImageUrl || item.image || ""
                };
            }

            $("#guessBox").autocomplete({
                source: function(request, response) {
                    console.log("Autocomplete request:", request.term);
                    $.ajax({
                        url: url,
                        type: 'GET',
                        data: { term: request.term },
                        dataType: 'json',
                        success: function(data) {
                            console.log("Autocomplete response:", data);
                            if (!Array.isArray(data)) {
                                response([]);
                                return;
                            }
                            const items = data.map(normalizeItem).slice(0, 10);
                            response(items);
                        },
                        error: function(xhr, status, err) {
                            console.error("Autocomplete AJAX error:", status, err, xhr.responseText);
                            response([]);
                        }
                    });
                },
                minLength: 2,
                focus: function(event, ui) {
                    event.preventDefault();
                    $("#guessBox").val(ui.item.value);
                },
                select: function(event, ui) {
                    $("#guessBox").val(ui.item.value);
                    return false;
                }
            })
            .autocomplete("instance")._renderItem = function (ul, item) {
            return $("<li>")
             .append(`<div class="ui-menu-item-wrapper">${item.label}</div>`)
             .appendTo(ul);
            };

        });
    })(jQuery);
</script>
