@model WhosThatPokemon.Models.ViewModels.GameSessionViewModel

@{
    ViewData["Title"] = "Classic Game";
    ViewData["BodyClass"] = "classic-game-page";
}
@{
    List<int> selectedGens = ViewBag.SelectedGens as List<int> ?? new List<int>();
}


<style>

@@font-face {
    font-family: 'Pokemon Solid';
    src: url('/fonts/Pokemon Solid.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}
@@font-face {
    font-family: 'Pokemon Hollow';
    src: url('/fonts/Pokemon Hollow.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
}

/* Base */
body {
    background-color: transparent;
    min-height: 100vh;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: 'Press Start 2P', cursive;
    color: #333;
}

/* Boton para regresar */
.back-button {
    position: fixed;
    top: 12px;
    left: 12px;
    z-index: 1400;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 44px;
    border-radius: 10px;
    background: linear-gradient(180deg,#1d5fe0,#124aa8);
    color: #fff;
    text-decoration: none;
    font-size: 26px;
    font-weight: 800;
    border: 3px solid rgba(10,40,120,0.9);
    box-shadow: 0 6px 14px rgba(10,40,120,0.28);
    transition: transform .12s ease, box-shadow .12s ease;
}
.back-button:hover, .back-button:focus {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 8px 18px rgba(10,40,120,0.36);
}

/* Título */
.title-fixed {
    position: fixed!important;
    top: 5px;
    left: 32%;
    transform: translateX(-50%); 
    z-index: 10;
    pointer-events: none;
    width: auto;
    display: flex;
    justify-content: center;
    padding: 0 8px;
}

.title-inner {
    position: relative;
    display: inline-block;
    pointer-events: none;
    text-align: center;
    line-height: 1;
    white-space: nowrap;
    width: max-content;
    height: auto;
    padding: 0;
}

.title-fixed .pokemon-title {
    margin: 0;
    padding: 0;
    display: block;
    position: absolute;
    left: 50%;
    top: 5px;
    transform: translateX(-50%);
    line-height: 1.1;
    font-size: clamp(32px, 8vw, 80px) !important;
    letter-spacing: 0.4px;
    user-select: none;
    pointer-events: none;
    text-align: center;
}


.title-fixed .pokemon-title.hollow {
    font-family: 'Pokemon Hollow', sans-serif;
    color: #2A75BB;  
    z-index: 1;

    text-shadow:
        -4px -4px 0 #0A285F,
         4px -4px 0 #0A285F,
        -4px  4px 0 #0A285F,
         4px  4px 0 #0A285F,
         0px  0px 10px #174a96;  
}

.title-fixed .pokemon-title.solid {
    font-family: 'Pokemon Solid', sans-serif;
    color: #FFCB05; 
    z-index: 2;

    text-shadow:
        0px 3px 0px #1B1B1B;
}

.pokemon-title.line1 {
    top: 0;
}

.pokemon-title.line2 {
    top: 100px;        
    padding-left: 150px; 
}

.game-container {
    background-color: transparent;
    border: none;
    box-shadow: none;
    margin-top: 250px;
    text-align: center;
    width: 90%;
    max-width: 1000px;
    position: relative;
    z-index: 1;
    padding-bottom: 40px;
    flex-grow: 1;
}


/* Filtros */
.generation-filter-container {
    background-color: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
    width: 100%;
    display: flex;
    flex-direction: row;   
    align-items: center;
    justify-content: center;
    gap: 10px;           
    margin-top: 20px;
    margin-bottom: 40px;
}

.gen-switch-container {
    display: flex;
    align-items: center;
    justify-content: center; 
}

.gen-filter { display: none; }

.gen-sprite-label {
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.gen-sprite-label img {
    width: 70px;   
    height: 70px; 
    image-rendering: pixelated; 
    transition: all 0.2s ease-in-out;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.7); 
    padding: 1px; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.gen-filter:not(:checked) + .gen-sprite-label img {
    filter: grayscale(100%);
    opacity: 0.6;
    background-color: rgba(0, 0, 0, 0.2); 
    box-shadow: none; 
}

.gen-sprite-label:hover img {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

/* Boton para reroll */
#reroll-button {
    background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png');
    background-size: 50px 50px; 
    background-repeat: no-repeat;
    background-position: center;
    background-color: rgba(255, 255, 255, 0.7); 
    width: 80px;   
    height: 80px; 
    border: none;
    border-radius: 50%; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
    cursor: pointer;
    font-size: 0;
    color: transparent;
    margin-top: 0; 
    margin-left: 15px; 
    transition: all 0.3s ease;
}

#reroll-button:hover {
    transform: scale(1.1) rotate(15deg);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

/* Barra de búsqueda */
.input-area { margin-bottom: 30px; display: flex; justify-content: center; align-items: flex-start; flex-wrap: wrap; }
.input-area label { display: block; margin-bottom: 10px; font-size: 1.2em; width: 100%; }
.autocomplete-container { position: relative; width: 60%; max-width: 300px; }
#pokemonNameInput { width: 100%; padding: 12px 15px; border: 3px solid #333; border-radius: 8px; font-size: 1.1em; box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1); text-transform: capitalize; }
.autocomplete-items { position: absolute; border: 1px solid #999; border-top: none; z-index: 99; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; font-size: 0.9em; }
.autocomplete-items div { padding: 5px 10px; cursor: pointer; background-color: #fff; border-bottom: 1px solid #d4d4d4; text-align: left; display: flex; align-items: center; }
.autocomplete-sprite { width: 40px; height: 40px; margin-right: 10px; image-rendering: pixelated; }
.autocomplete-items div:hover { background-color: #e9e9e9; }
.input-area button { padding: 12px 25px; background-color: #007bff; color: white; border: 3px solid #0056b3; border-radius: 8px; font-size: 1.1em; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; box-shadow: 3px 3px 0px rgba(0,0,0,0.3); margin-left: 10px; }
.input-area button:hover { background-color: #0056b3; transform: translateY(-2px); }

/* Tabla */
.table-container { overflow-x: auto; margin-top: 20px; }
table { width: 100%; border-collapse: separate; border-spacing: 0; background-color: transparent; border: none; box-shadow: none; }
th, td { padding: 4px; text-align: center; vertical-align: middle; background: transparent !important; border: none !important; }
th { color: #333; font-weight: bold; font-size: 0.9em; padding-bottom: 10px; }

.guess-square { 
    width: 90px; height: 90px;
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    background-color: #003a70;
    color: white;
    font-size: 1em;
    font-weight: bold;
    padding: 5px;
    text-align: center;
    line-height: 1.3;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.guess-square.green { background-color: #28a745; }
.guess-square.red { background-color: #dc3545; }
.guess-square.yellow { background-color: #ffc107; }

.pokemon-image { width: 90px; height: 90px; object-fit: contain; }

.game-over-message { font-size: 1.8em; color: #28a745; font-weight: bold; margin-top: 20px; text-shadow: 1px 1px 0px #000; }
.error-message { color: #dc3545; font-weight: bold; margin-bottom: 15px; }

</style>

<a asp-controller="Games" asp-action="Index" class="back-button" title="Volver a Games" aria-label="Volver a Games">
    &#8592;
</a>

<div class="title-fixed" aria-hidden="false">
    <div class="title-inner" role="img" aria-label="¿Quién es ese Pokémon?">
        <h1 class="pokemon-title hollow line1" aria-hidden="true">¿Quién es ese</h1>
        <h1 class="pokemon-title hollow line2" aria-hidden="true">Pokémon?</h1>

        <h1 class="pokemon-title solid line1" aria-hidden="true">¿Quién es ese</h1>
        <h1 class="pokemon-title solid line2" aria-hidden="true">Pokémon?</h1>

    </div>
</div>

<div class="game-container">  

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="error-message">
            @TempData["ErrorMessage"]
        </div>
    }

    @if (Model != null && Model.HasGuessedCorrectly)
    {
        <p class="game-over-message">¡Felicidades, Lograste adivinar el Pokemon!</p>
        <p>El Pokémon era: <strong>@Model.Guesses.First().Name</strong></p>
        <img src="@Model.Guesses.First().ImageUrl" alt="@Model.Guesses.First().Name" class="pokemon-image" style="width:120px; height:120px;" />
        <br />
        <a href="@Url.Action("Index", "ClassicGame")" class="input-area button" style="text-decoration:none; display:inline-block; margin-top:20px;">
            Jugar de nuevo
        </a>
    }
    else
    {
        <form asp-controller="ClassicGame" asp-action="Guess" method="post" class="input-area">

            <div class="autocomplete-container" data-url="@Url.Action("SearchPokemon", "ClassicGame")">
                <input type="text" id="pokemonNameInput" name="CurrentGuessName" value="@(Model?.CurrentGuessName)" placeholder="Escribe aquí" autocomplete="off" required />
                <div id="autocomplete-list" class="autocomplete-items"></div>
            </div>

            <button type="submit">Adivinar</button>
        </form>

        @if (Model?.Guesses != null && Model.Guesses.Any())
        {
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Pokémon</th>
                            <th>Tipo 1</th>
                            <th>Tipo 2</th>
                            <th>Etapa Evolutiva</th>
                            <th>Color</th>
                            <th>Gen</th>
                            <th>Altura (m)</th>
                            <th>Peso (Kg)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var guess in Model.Guesses)
                        {
                            <tr>
                                <td><img src="@guess.ImageUrl" alt="@guess.Name" class="pokemon-image" /></td>
                                <td><div class="guess-square @guess.Type1Color">@guess.Type1</div></td>
                                <td><div class="guess-square @guess.Type2Color">@guess.Type2</div></td>
                                <td><div class="guess-square @guess.EvolutionStageColor">@guess.EvolutionStage</div></td>
                                <td><div class="guess-square @guess.ColorColor" style="font-size:0.8em; line-height:1.2;">@guess.Color</div></td>
                                <td><div class="guess-square @guess.GenerationColor">@guess.Generation</div></td>
                                <td><div class="guess-square @guess.HeightColor">@guess.Height</div></td>
                                <td><div class="guess-square @guess.WeightColor">@guess.Weight</div></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    }
</div>

<div class="generation-filter-container">
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-1" class="gen-filter" name="gens" value="1"   @(selectedGens.Contains(1) ? "checked" : "")>
        <label for="gen-1" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" alt="Gen1"></label>
    </div>
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-2" class="gen-filter" name="gens" value="2" @(selectedGens.Contains(2) ? "checked" : "")>
        <label for="gen-2" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/152.png" alt="Gen2"></label>
    </div>
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-3" class="gen-filter" name="gens" value="3" @(selectedGens.Contains(3) ? "checked" : "")>
        <label for="gen-3" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/258.png" alt="Gen3"></label>
    </div>
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-4" class="gen-filter" name="gens" value="4" @(selectedGens.Contains(4) ? "checked" : "")>
        <label for="gen-4" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/390.png" alt="Gen4"></label>
    </div>
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-5" class="gen-filter" name="gens" value="5" @(selectedGens.Contains(5) ? "checked" : "")>
        <label for="gen-5" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/495.png" alt="Gen5"></label>
    </div>
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-6" class="gen-filter" name="gens" value="6" @(selectedGens.Contains(6) ? "checked" : "")>
        <label for="gen-6" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/656.png" alt="Gen6"></label>
    </div>
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-7" class="gen-filter" name="gens" value="7" @(selectedGens.Contains(7) ? "checked" : "")>
        <label for="gen-7" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/725.png" alt="Gen7"></label>
    </div>
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-8" class="gen-filter" name="gens" value="8" @(selectedGens.Contains(8) ? "checked" : "")>
        <label for="gen-8" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/810.png" alt="Gen8"></label>
    </div>
    <div class="gen-switch-container">
        <input type="checkbox" id="gen-9" class="gen-filter" name="gens" value="9" @(selectedGens.Contains(9) ? "checked" : "")>
        <label for="gen-9" class="gen-sprite-label"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/912.png" alt="Gen9"></label>
    </div>

    <button id="reroll-button" title="Reroll Pokémon"></button>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    const container = document.querySelector(".autocomplete-container");
    const input = document.getElementById("pokemonNameInput");
    const autocompleteList = document.getElementById("autocomplete-list");
    const searchUrl = container ? container.dataset.url : null;

    if (input && searchUrl) {
        input.addEventListener("input", async function() {
            let val = this.value;
            closeAllLists();
            if (!val || val.length < 2) return;

            try {
                const response = await fetch(`${searchUrl}?term=${encodeURIComponent(val)}`);
                if (!response.ok) return;

                const suggestions = await response.json();

                suggestions.forEach(s => {
                    const itemDiv = document.createElement("div");

                    itemDiv.innerHTML = `
                        <img src="${s.imageUrl || ''}" class="autocomplete-sprite" alt="${s.name}">
                        <span><strong>${s.name.substr(0, val.length)}</strong>${s.name.substr(val.length)}</span>
                    `;

                    itemDiv.addEventListener("click", function() {
                        input.value = s.name;
                        closeAllLists();
                    });

                    autocompleteList.appendChild(itemDiv);
                });

            } catch (error) {
                console.error(error);
            }
        });
    }

    function closeAllLists() { if (autocompleteList) autocompleteList.innerHTML = ''; }

    document.addEventListener("click", e => {
        if (input && e.target !== input) closeAllLists();
    });

    const rerollButton = document.getElementById("reroll-button");
    if (rerollButton) {
        rerollButton.addEventListener("click", function() {
        const checkedGens = document.querySelectorAll(".gen-filter:checked");
        const params = new URLSearchParams();

        checkedGens.forEach(c => params.append("gens", c.value));

        // Si el usuario no selecciona nada, default a gen 1–9
        if (![...checkedGens].length) {
            for (let i = 1; i <= 9; i++) params.append("gens", i);
        }

        window.location.href = `/ClassicGame?${params.toString()}`;

        });
    }
});
</script>